{% extends 'base.html' %}
{% load static %}

{% block title %}–ù–æ–≤–æ—Å—Ç–∏ - {{ SITE_NAME }}{% endblock %}
{% block description %}–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –æ —Ç–µ–ª–µ–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è—Ö, –±–ª–æ–∫—á–µ–π–Ω–µ –∏ —Å–ø—É—Ç–Ω–∏–∫–æ–≤—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö{% endblock %}

{% block extra_css %}
<style>
    .news-page {
        min-height: 100vh;
        background: #1b1523;
        padding: 2rem;
    }
    
    .news-header {
        max-width: 1200px;
        margin: 0 auto 3rem;
        text-align: center;
    }
    
    .news-title {
        font-size: 3rem;
        color: #6ee7ff;
        margin-bottom: 1rem;
        font-weight: 700;
        letter-spacing: 1px;
    }
    
    .news-subtitle {
        color: #94a3b8;
        font-size: 1.2rem;
        max-width: 800px;
        margin: 0 auto;
        line-height: 1.6;
    }
    
    .news-container {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 2rem;
    }
    
    .news-sidebar {
        background: rgba(46, 45, 46, 0.8);
        border-radius: 16px;
        padding: 1.5rem;
        border: 1px solid rgba(110, 231, 255, 0.1);
        height: fit-content;
        position: sticky;
        top: 2rem;
    }
    
    .sidebar-title {
        color: #6ee7ff;
        font-size: 1.2rem;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid rgba(110, 231, 255, 0.1);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .filter-section {
        margin-bottom: 2rem;
    }
    
    .filter-title {
        color: #cbd5e1;
        font-size: 1rem;
        margin-bottom: 0.75rem;
        font-weight: 600;
    }
    
    .filter-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .filter-tag {
        padding: 0.5rem 1rem;
        background: rgba(51, 49, 53, 0.8);
        border: 1px solid rgba(110, 231, 255, 0.1);
        border-radius: 20px;
        color: #94a3b8;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .filter-tag:hover {
        border-color: #6ee7ff;
        color: #6ee7ff;
    }
    
    .filter-tag.active {
        background: rgba(110, 231, 255, 0.2);
        border-color: #6ee7ff;
        color: #6ee7ff;
        font-weight: 600;
    }
    
    .source-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .source-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .source-item:hover {
        background: rgba(110, 231, 255, 0.05);
    }
    
    .source-item.active {
        background: rgba(110, 231, 255, 0.1);
        border-left: 3px solid #6ee7ff;
    }
    
    .source-icon {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.9rem;
    }
    
    .icon-habr { background: #77b900; color: white; }
    .icon-reddit { background: #ff4500; color: white; }
    .icon-twitter { background: #1da1f2; color: white; }
    .icon-techcrunch { background: #00a562; color: white; }
    
    .source-name {
        color: #cbd5e1;
        flex: 1;
        font-size: 0.95rem;
    }
    
    .source-count {
        color: #6ee7ff;
        font-size: 0.85rem;
        background: rgba(110, 231, 255, 0.1);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        min-width: 24px;
        text-align: center;
    }
    
    .update-info {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid rgba(110, 231, 255, 0.1);
    }
    
    .update-time {
        color: #94a3b8;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .update-btn {
        width: 100%;
        padding: 0.75rem;
        background: linear-gradient(135deg, #6ee7ff 0%, #3b82f6 100%);
        border: none;
        border-radius: 8px;
        color: #0f172a;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: 'CGXYZ PC', sans-serif;
    }
    
    .update-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
    }
    
    .update-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    .news-content {
        background: rgba(46, 45, 46, 0.8);
        border-radius: 16px;
        padding: 2rem;
        border: 1px solid rgba(110, 231, 255, 0.1);
    }
    
    .news-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid rgba(110, 231, 255, 0.1);
    }
    
    .news-count {
        color: #6ee7ff;
        font-size: 1.1rem;
        font-weight: 600;
    }
    
    .sort-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .sort-label {
        color: #94a3b8;
        font-size: 0.9rem;
    }
    
    .sort-select {
        background: rgba(51, 49, 53, 0.8);
        border: 1px solid rgba(110, 231, 255, 0.2);
        border-radius: 8px;
        color: #cbd5e1;
        padding: 0.5rem 1rem;
        font-family: 'CGXYZ PC', sans-serif;
        min-width: 150px;
    }
    
    .news-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }
    
    .news-card {
        background: rgba(51, 49, 53, 0.8);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid rgba(110, 231, 255, 0.05);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .news-card:hover {
        border-color: #6ee7ff;
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(110, 231, 255, 0.1);
    }
    
    .news-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }
    
    .news-card-category {
        padding: 0.35rem 1rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        letter-spacing: 0.5px;
    }
    
    .category-telecom { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .category-blockchain { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
    .category-satellite { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    .category-cybersecurity { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .category-infrastructure { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .category-general { background: rgba(148, 163, 184, 0.2); color: #94a3b8; }
    
    .news-card-verified {
        color: #22c55e;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .news-card-title {
        color: #ffffff;
        font-size: 1.3rem;
        margin-bottom: 1rem;
        line-height: 1.4;
        font-weight: 600;
    }
    
    .news-card-excerpt {
        color: #94a3b8;
        line-height: 1.6;
        margin-bottom: 1.5rem;
        font-size: 0.95rem;
    }
    
    .news-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 1rem;
        border-top: 1px solid rgba(110, 231, 255, 0.05);
    }
    
    .news-card-source {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .news-card-author {
        color: #cbd5e1;
        font-size: 0.9rem;
    }
    
    .news-card-date {
        color: #94a3b8;
        font-size: 0.85rem;
    }
    
    .news-card-actions {
        display: flex;
        gap: 1rem;
    }
    
    .news-action-btn {
        padding: 0.5rem 1rem;
        background: transparent;
        border: 1px solid rgba(110, 231, 255, 0.2);
        border-radius: 6px;
        color: #94a3b8;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .news-action-btn:hover {
        border-color: #6ee7ff;
        color: #6ee7ff;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid rgba(110, 231, 255, 0.1);
    }
    
    .page-btn {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(51, 49, 53, 0.8);
        border: 1px solid rgba(110, 231, 255, 0.1);
        border-radius: 8px;
        color: #cbd5e1;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .page-btn:hover:not(.disabled) {
        border-color: #6ee7ff;
        color: #6ee7ff;
    }
    
    .page-btn.active {
        background: rgba(110, 231, 255, 0.2);
        border-color: #6ee7ff;
        color: #6ee7ff;
        font-weight: 600;
    }
    
    .page-btn.disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }
    
    .page-dots {
        color: #94a3b8;
        padding: 0 0.5rem;
    }
    
    .no-news {
        text-align: center;
        padding: 4rem 2rem;
        color: #94a3b8;
    }
    
    .loading-news {
        text-align: center;
        padding: 3rem;
        color: #6ee7ff;
    }
    
    @media (max-width: 1024px) {
        .news-container {
            grid-template-columns: 1fr;
        }
        
        .news-sidebar {
            position: static;
        }
    }
    
    @media (max-width: 768px) {
        .news-page {
            padding: 1rem;
        }
        
        .news-title {
            font-size: 2rem;
        }
        
        .news-controls {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .news-card-footer {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .news-card-actions {
            width: 100%;
            justify-content: space-between;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="news-page">
    <div class="news-header">
        <h1 class="news-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏</h1>
        <p class="news-subtitle">
            –ê–≥—Ä–µ–≥–∞—Ü–∏—è –Ω–æ–≤–æ—Å—Ç–µ–π –æ —Ç–µ–ª–µ–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è—Ö, –±–ª–æ–∫—á–µ–π–Ω–µ, —Å–ø—É—Ç–Ω–∏–∫–æ–≤—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö 
            –∏ –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏–∑ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        </p>
    </div>
    
    <div class="news-container">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
        <aside class="news-sidebar">
            <div class="sidebar-title">
                <span>‚öôÔ∏è</span> –§–∏–ª—å—Ç—Ä—ã
            </div>
            
            <div class="filter-section">
                <div class="filter-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
                <div class="filter-tags" id="category-filters">
                    <span class="filter-tag active" data-category="">–í—Å–µ</span>
                    <span class="filter-tag" data-category="TELECOM">–¢–µ–ª–µ–∫–æ–º</span>
                    <span class="filter-tag" data-category="BLOCKCHAIN">–ë–ª–æ–∫—á–µ–π–Ω</span>
                    <span class="filter-tag" data-category="SATELLITE">–°–ø—É—Ç–Ω–∏–∫–∏</span>
                    <span class="filter-tag" data-category="CYBERSECURITY">–ö–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</span>
                    <span class="filter-tag" data-category="INFRASTRUCTURE">–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞</span>
                </div>
            </div>
            
            <div class="filter-section">
                <div class="filter-title">–ò—Å—Ç–æ—á–Ω–∏–∫–∏</div>
                <div class="source-list" id="source-filters">
                    <div class="source-item active" data-source="">
                        <div class="source-icon" style="background: #6ee7ff;">ALL</div>
                        <span class="source-name">–í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏</span>
                        <span class="source-count" id="count-all">{{ news_list.paginator.count }}</span>
                    </div>
                    <div class="source-item" data-source="HABR">
                        <div class="source-icon icon-habr">H</div>
                        <span class="source-name">–•–∞–±—Ä</span>
                        <span class="source-count" id="count-habr">0</span>
                    </div>
                    <div class="source-item" data-source="REDDIT">
                        <div class="source-icon icon-reddit">R</div>
                        <span class="source-name">Reddit</span>
                        <span class="source-count" id="count-reddit">0</span>
                    </div>
                    <div class="source-item" data-source="TWITTER">
                        <div class="source-icon icon-twitter">T</div>
                        <span class="source-name">Twitter/X</span>
                        <span class="source-count" id="count-twitter">0</span>
                    </div>
                    <div class="source-item" data-source="TECH_CRUNCH">
                        <div class="source-icon icon-techcrunch">TC</div>
                        <span class="source-name">TechCrunch</span>
                        <span class="source-count" id="count-techcrunch">0</span>
                    </div>
                </div>
            </div>
            
            <div class="update-info">
                <div class="update-time">
                    <span>üïí</span>
                    <span>–û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="last-update">—Ç–æ–ª—å–∫–æ —á—Ç–æ</span></span>
                </div>
                <button class="update-btn" id="update-news-btn" onclick="updateNews()">
                    üîÑ –û–±–Ω–æ–≤–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏
                </button>
            </div>
        </aside>
        
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <main class="news-content">
            <div class="news-controls">
                <div class="news-count">
                    –ù–∞–π–¥–µ–Ω–æ –Ω–æ–≤–æ—Å—Ç–µ–π: <span id="total-count">{{ news_list.paginator.count }}</span>
                </div>
                <div class="sort-controls">
                    <span class="sort-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</span>
                    <select class="sort-select" id="sort-select" onchange="sortNews()">
                        <option value="newest">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                        <option value="oldest">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
                        <option value="verified">–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ</option>
                    </select>
                </div>
            </div>
            
            <div class="news-list" id="news-list">
                {% if news_list %}
                    {% for news in news_list %}
                    <div class="news-card" data-id="{{ news.id }}" 
                         data-category="{{ news.category }}" 
                         data-source="{{ news.source }}"
                         onclick="window.open('{{ news.url }}', '_blank')">
                        
                        <div class="news-card-header">
                            <span class="news-card-category category-{{ news.category|lower }}">
                                {{ news.get_category_display }}
                            </span>
                            {% if news.is_verified %}
                            <span class="news-card-verified">
                                <span>‚úì</span>
                                <span>–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</span>
                            </span>
                            {% endif %}
                        </div>
                        
                        <h3 class="news-card-title">{{ news.title }}</h3>
                        
                        <p class="news-card-excerpt">{{ news.excerpt }}</p>
                        
                        <div class="news-card-footer">
                            <div class="news-card-source">
                                <div class="source-icon 
                                    {% if news.source == 'HABR' %}icon-habr
                                    {% elif news.source == 'REDDIT' %}icon-reddit
                                    {% elif news.source == 'TWITTER' %}icon-twitter
                                    {% elif news.source == 'TECH_CRUNCH' %}icon-techcrunch
                                    {% endif %}">
                                    {{ news.source|slice:":1" }}
                                </div>
                                <div>
                                    <div class="news-card-author">{{ news.author|default:"–ê–≤—Ç–æ—Ä –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω" }}</div>
                                    <div class="news-card-date">{{ news.published_date|date:"d.m.Y H:i" }}</div>
                                </div>
                            </div>
                            
                            <div class="news-card-actions">
                                <button class="news-action-btn" onclick="event.stopPropagation(); saveForLater({{ news.id }})">
                                    <span>üìå</span>
                                    <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
                                </button>
                                <button class="news-action-btn" onclick="event.stopPropagation(); shareNews('{{ news.url }}', '{{ news.title }}')">
                                    <span>‚ÜóÔ∏è</span>
                                    <span>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-news">
                        <h3>–ù–æ–≤–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–æ–≤–æ—Å—Ç–µ–π</p>
                    </div>
                {% endif %}
            </div>
            
            <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
            {% if news_list.has_other_pages %}
            <div class="pagination">
                {% if news_list.has_previous %}
                    <a href="?page=1{% if current_category %}&category={{ current_category }}{% endif %}{% if current_source %}&source={{ current_source }}{% endif %}" 
                       class="page-btn">¬´¬´</a>
                    <a href="?page={{ news_list.previous_page_number }}{% if current_category %}&category={{ current_category }}{% endif %}{% if current_source %}&source={{ current_source }}{% endif %}" 
                       class="page-btn">¬´</a>
                {% else %}
                    <span class="page-btn disabled">¬´¬´</span>
                    <span class="page-btn disabled">¬´</span>
                {% endif %}
                
                {% for num in news_list.paginator.page_range %}
                    {% if news_list.number == num %}
                        <span class="page-btn active">{{ num }}</span>
                    {% elif num > news_list.number|add:'-3' and num < news_list.number|add:'3' %}
                        <a href="?page={{ num }}{% if current_category %}&category={{ current_category }}{% endif %}{% if current_source %}&source={{ current_source }}{% endif %}" 
                           class="page-btn">{{ num }}</a>
                    {% endif %}
                {% endfor %}
                
                {% if news_list.has_next %}
                    <a href="?page={{ news_list.next_page_number }}{% if current_category %}&category={{ current_category }}{% endif %}{% if current_source %}&source={{ current_source }}{% endif %}" 
                       class="page-btn">¬ª</a>
                    <a href="?page={{ news_list.paginator.num_pages }}{% if current_category %}&category={{ current_category }}{% endif %}{% if current_source %}&source={{ current_source }}{% endif %}" 
                       class="page-btn">¬ª¬ª</a>
                {% else %}
                    <span class="page-btn disabled">¬ª</span>
                    <span class="page-btn disabled">¬ª¬ª</span>
                {% endif %}
            </div>
            {% endif %}
        </main>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
<div class="modal-overlay" id="update-modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–µ–π</h3>
            <button class="close-modal" onclick="closeUpdateModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div id="update-progress">
                <div class="progress-text">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-stats" id="progress-stats"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentCategory = '{{ current_category|default:"" }}';
    let currentSource = '{{ current_source|default:"" }}';
    let currentSort = 'newest';
    let isUpdating = false;
    
    document.addEventListener('DOMContentLoaded', function() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        initFilters();
        
        // –ü–æ–¥—Å—á–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
        countNewsBySource();
        
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        if (currentCategory) {
            document.querySelectorAll('#category-filters .filter-tag').forEach(tag => {
                if (tag.dataset.category === currentCategory) {
                    tag.classList.add('active');
                } else {
                    tag.classList.remove('active');
                }
            });
        }
        
        if (currentSource) {
            document.querySelectorAll('#source-filters .source-item').forEach(item => {
                if (item.dataset.source === currentSource) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
    });
    
    function initFilters() {
        // –§–∏–ª—å—Ç—Ä—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        document.querySelectorAll('#category-filters .filter-tag').forEach(tag => {
            tag.addEventListener('click', function() {
                document.querySelectorAll('#category-filters .filter-tag').forEach(t => {
                    t.classList.remove('active');
                });
                this.classList.add('active');
                currentCategory = this.dataset.category;
                applyFilters();
            });
        });
        
        // –§–∏–ª—å—Ç—Ä—ã –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
        document.querySelectorAll('#source-filters .source-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('#source-filters .source-item').forEach(i => {
                    i.classList.remove('active');
                });
                this.classList.add('active');
                currentSource = this.dataset.source;
                applyFilters();
            });
        });
    }
    
    function applyFilters() {
        const newsCards = document.querySelectorAll('.news-card');
        let visibleCount = 0;
        
        newsCards.forEach(card => {
            const categoryMatch = !currentCategory || card.dataset.category === currentCategory;
            const sourceMatch = !currentSource || card.dataset.source === currentSource;
            
            if (categoryMatch && sourceMatch) {
                card.style.display = 'block';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞
        document.getElementById('total-count').textContent = visibleCount;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ URL –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        updateUrl();
    }
    
    function updateUrl() {
        const params = new URLSearchParams();
        if (currentCategory) params.set('category', currentCategory);
        if (currentSource) params.set('source', currentSource);
        
        const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        window.history.replaceState({}, '', newUrl);
    }
    
    function countNewsBySource() {
        const counts = {
            'HABR': 0,
            'REDDIT': 0,
            'TWITTER': 0,
            'TECH_CRUNCH': 0,
            'OTHER': 0
        };
        
        document.querySelectorAll('.news-card').forEach(card => {
            const source = card.dataset.source;
            if (counts.hasOwnProperty(source)) {
                counts[source]++;
            }
        });
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤
        Object.keys(counts).forEach(source => {
            const element = document.getElementById(`count-${source.toLowerCase()}`);
            if (element) {
                element.textContent = counts[source];
            }
        });
    }
    
    function sortNews() {
        const sortValue = document.getElementById('sort-select').value;
        currentSort = sortValue;
        
        const newsList = document.getElementById('news-list');
        const cards = Array.from(newsList.querySelectorAll('.news-card'));
        
        cards.sort((a, b) => {
            const aDate = new Date(a.querySelector('.news-card-date').textContent);
            const bDate = new Date(b.querySelector('.news-card-date').textContent);
            const aVerified = a.querySelector('.news-card-verified') !== null;
            const bVerified = b.querySelector('.news-card-verified') !== null;
            
            if (sortValue === 'newest') {
                return bDate - aDate;
            } else if (sortValue === 'oldest') {
                return aDate - bDate;
            } else if (sortValue === 'verified') {
                if (aVerified && !bVerified) return -1;
                if (!aVerified && bVerified) return 1;
                return bDate - aDate;
            }
            return 0;
        });
        
        // –ü–µ—Ä–µ–∑–∞–ø–∏—Å—å –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –Ω–æ–≤–æ–º –ø–æ—Ä—è–¥–∫–µ
        cards.forEach(card => newsList.appendChild(card));
    }
    
    function updateNews() {
        if (isUpdating) return;
        
        isUpdating = true;
        const btn = document.getElementById('update-news-btn');
        btn.disabled = true;
        btn.innerHTML = 'üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
        
        // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        document.getElementById('update-modal').style.display = 'flex';
        updateProgress(0, '–ù–∞—á–∞–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...');
        
        // –°–∏–º—É–ª—è—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        simulateUpdate();
    }
    
    function simulateUpdate() {
        const steps = [
            { progress: 10, message: '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º...' },
            { progress: 25, message: '–ü–∞—Ä—Å–∏–Ω–≥ –•–∞–±—Ä–∞...' },
            { progress: 40, message: '–ó–∞–≥—Ä—É–∑–∫–∞ Reddit...' },
            { progress: 60, message: '–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–≤–∏—Ç–æ–≤...' },
            { progress: 75, message: '–ê–Ω–∞–ª–∏–∑ TechCrunch...' },
            { progress: 90, message: '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...' },
            { progress: 100, message: '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!' }
        ];
        
        let currentStep = 0;
        
        const interval = setInterval(() => {
            if (currentStep < steps.length) {
                const step = steps[currentStep];
                updateProgress(step.progress, step.message);
                currentStep++;
            } else {
                clearInterval(interval);
                finishUpdate();
            }
        }, 500);
    }
    
    function updateProgress(percent, message) {
        document.getElementById('progress-fill').style.width = percent + '%';
        document.querySelector('.progress-text').textContent = message;
        document.getElementById('progress-stats').innerHTML = `
            <div style="color: #6ee7ff; margin-top: 1rem;">
                –ü—Ä–æ–≥—Ä–µ—Å—Å: ${percent}%
            </div>
        `;
    }
    
    function finishUpdate() {
        setTimeout(() => {
            document.getElementById('update-modal').style.display = 'none';
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
            const btn = document.getElementById('update-news-btn');
            btn.disabled = false;
            btn.innerHTML = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏';
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
            const now = new Date();
            document.getElementById('last-update').textContent = 
                now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            
            isUpdating = false;
            
            // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            showNotification('–ù–æ–≤–æ—Å—Ç–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!', 'success');
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π
            setTimeout(() => {
                window.location.reload();
            }, 1500);
            
        }, 1000);
    }
    
    function closeUpdateModal() {
        if (!isUpdating) {
            document.getElementById('update-modal').style.display = 'none';
        }
    }
    
    function saveForLater(newsId) {
        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∑–¥–µ—Å—å –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        showNotification('–ù–æ–≤–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —á—Ç–µ–Ω–∏—è', 'info');
    }
    
    function shareNews(url, title) {
        if (navigator.share) {
            navigator.share({
                title: title,
                text: '–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —ç—Ç—É –Ω–æ–≤–æ—Å—Ç—å –Ω–∞ Z96A',
                url: url
            });
        } else {
            // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
            navigator.clipboard.writeText(url);
            showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'info');
        }
    }
    
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <span class="notification-icon">${type === 'success' ? '‚úì' : 'üí°'}</span>
                <span>${message}</span>
            </div>
        `;
        
        document.getElementById('notifications').appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
</script>
{% endblock %}