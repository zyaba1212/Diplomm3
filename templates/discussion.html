{% extends "base.html" %}

{% block title %}Community Discussions - Z96A Network{% endblock %}

{% block page_title %}
<div class="hero-header">
    <h1>Community Discussions</h1>
    <p class="hero-subtitle">Share knowledge, ask questions, and collaborate with network professionals</p>
</div>
{% endblock %}

{% block content %}
<div class="container">
    <div class="discussion-layout">
        <!-- Sidebar with filters -->
        <aside class="discussion-sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title">
                    <span class="sidebar-icon">🔍</span>
                    Filters
                </h3>
                
                <div class="filter-group">
                    <label class="filter-label">Content Type</label>
                    <select class="filter-select" id="filterType">
                        <option value="">All Types</option>
                        <option value="cable">Cable Discussion</option>
                        <option value="news">News Discussion</option>
                        <option value="technical">Technical</option>
                        <option value="general">General</option>
                        <option value="suggestion">Suggestion</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Cable</label>
                    <select class="filter-select" id="filterCable">
                        <option value="">All Cables</option>
                        {% for cable in cables|slice:":20" %}
                        <option value="{{ cable.cable_id }}">{{ cable.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Sort By</label>
                    <select class="filter-select" id="filterSort">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="popular">Most Popular</option>
                        <option value="replies">Most Replies</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Time Range</label>
                    <select class="filter-select" id="filterTime">
                        <option value="">All Time</option>
                        <option value="day">Last 24 Hours</option>
                        <option value="week">Last Week</option>
                        <option value="month">Last Month</option>
                        <option value="year">Last Year</option>
                    </select>
                </div>
                
                <button class="btn btn-block" id="applyFilters">
                    Apply Filters
                </button>
                <button class="btn btn-block btn-outline" id="resetFilters">
                    Reset Filters
                </button>
            </div>
            
            <div class="sidebar-section">
                <h3 class="sidebar-title">
                    <span class="sidebar-icon">📊</span>
                    Statistics
                </h3>
                
                <div class="stats-grid">
                    <div class="stat">
                        <div class="stat-number" id="totalDiscussions">0</div>
                        <div class="stat-label">Total Discussions</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="todayDiscussions">0</div>
                        <div class="stat-label">Today</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="totalReplies">0</div>
                        <div class="stat-label">Total Replies</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="activeUsers">0</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3 class="sidebar-title">
                    <span class="sidebar-icon">🏆</span>
                    Top Contributors
                </h3>
                
                <div class="contributors-list" id="topContributors">
                    <!-- Loaded via JavaScript -->
                    <div class="loading-indicator">
                        <div class="spinner-small"></div>
                        <p>Loading contributors...</p>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3 class="sidebar-title">
                    <span class="sidebar-icon">📌</span>
                    Community Guidelines
                </h3>
                
                <div class="guidelines">
                    <div class="guideline">
                        <span class="guideline-icon">👍</span>
                        <span class="guideline-text">Be respectful and professional</span>
                    </div>
                    <div class="guideline">
                        <span class="guideline-icon">🎯</span>
                        <span class="guideline-text">Stay on topic</span>
                    </div>
                    <div class="guideline">
                        <span class="guideline-icon">🔒</span>
                        <span class="guideline-text">No sensitive information</span>
                    </div>
                    <div class="guideline">
                        <span class="guideline-icon">💡</span>
                        <span class="guideline-text">Share knowledge generously</span>
                    </div>
                    <div class="guideline">
                        <span class="guideline-icon">⭐</span>
                        <span class="guideline-text">Reward helpful contributions</span>
                    </div>
                </div>
                
                <a href="#" class="btn-link">View full guidelines →</a>
            </div>
        </aside>

        <!-- Main content area -->
        <main class="discussion-main">
            <!-- Create new discussion -->
            <div class="create-discussion-card" id="createDiscussionCard">
                <div class="card-header">
                    <h3>Start a New Discussion</h3>
                    <button class="btn-toggle" id="toggleCreateForm">
                        <span class="toggle-icon">+</span>
                    </button>
                </div>
                
                <div class="create-form" id="createDiscussionForm" style="display: none;">
                    <form id="newDiscussionForm">
                        {% csrf_token %}
                        
                        <div class="form-group">
                            <label for="discussionTitle">Title *</label>
                            <input type="text" 
                                   id="discussionTitle" 
                                   class="form-control" 
                                   placeholder="What would you like to discuss?"
                                   maxlength="200"
                                   required>
                            <div class="form-help">Be specific and descriptive</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="discussionContent">Content *</label>
                            <textarea id="discussionContent" 
                                     class="form-control" 
                                     rows="5"
                                     placeholder="Share your thoughts, questions, or insights..."
                                     maxlength="5000"
                                     required></textarea>
                            <div class="form-help">Markdown is supported</div>
                            <div class="char-counter">
                                <span id="charCount">0</span>/5000 characters
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="discussionType">Type</label>
                                <select id="discussionType" class="form-control">
                                    <option value="general">General Discussion</option>
                                    <option value="cable">Cable Discussion</option>
                                    <option value="technical">Technical Question</option>
                                    <option value="news">News Discussion</option>
                                    <option value="suggestion">Suggestion</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="discussionCable">Related Cable (Optional)</label>
                                <select id="discussionCable" class="form-control">
                                    <option value="">Select a cable</option>
                                    {% for cable in cables|slice:":50" %}
                                    <option value="{{ cable.cable_id }}">{{ cable.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="submitDiscussion">
                                <span class="btn-icon">💬</span>
                                Create Discussion
                            </button>
                            <button type="button" class="btn btn-outline" id="cancelDiscussion">
                                Cancel
                            </button>
                            <div class="form-note">
                                Earn 5 ZETA tokens for creating a discussion
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Discussions list -->
            <div class="discussions-container">
                <div class="discussions-header">
                    <h2>Recent Discussions</h2>
                    <div class="header-actions">
                        <div class="search-box">
                            <input type="text" 
                                   id="searchDiscussions" 
                                   placeholder="Search discussions..."
                                   class="search-input">
                            <button class="search-btn" id="searchBtn">
                                <span>🔍</span>
                            </button>
                        </div>
                        <button class="btn btn-sm" id="refreshDiscussions">
                            <span>🔄</span> Refresh
                        </button>
                    </div>
                </div>
                
                <!-- Pinned discussions -->
                <div class="discussion-section" id="pinnedDiscussions">
                    <h3 class="section-title">
                        <span class="section-icon">📌</span>
                        Pinned Discussions
                    </h3>
                    <div class="discussions-list" id="pinnedList">
                        <!-- Pinned discussions will be loaded here -->
                    </div>
                </div>
                
                <!-- Regular discussions -->
                <div class="discussion-section" id="regularDiscussions">
                    <h3 class="section-title">
                        <span class="section-icon">💬</span>
                        All Discussions
                    </h3>
                    
                    <!-- Loading state -->
                    <div class="loading-state" id="discussionsLoading">
                        <div class="spinner"></div>
                        <p>Loading discussions...</p>
                    </div>
                    
                    <!-- Discussions list -->
                    <div class="discussions-list" id="discussionsList">
                        <!-- Discussions will be loaded here via JavaScript -->
                    </div>
                    
                    <!-- Pagination -->
                    <div class="pagination" id="discussionsPagination">
                        <!-- Pagination will be loaded here -->
                    </div>
                    
                    <!-- Empty state -->
                    <div class="empty-state" id="emptyDiscussions" style="display: none;">
                        <div class="empty-icon">💬</div>
                        <h3>No discussions found</h3>
                        <p>Be the first to start a discussion!</p>
                        <button class="btn btn-primary" id="startFirstDiscussion">
                            Start a Discussion
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Discussion template (hidden) -->
            <template id="discussionTemplate">
                <div class="discussion-item" data-discussion-id="{id}">
                    <div class="discussion-votes">
                        <button class="vote-btn upvote" data-action="upvote">
                            <span>↑</span>
                        </button>
                        <div class="vote-count">{vote_score}</div>
                        <button class="vote-btn downvote" data-action="downvote">
                            <span>↓</span>
                        </button>
                    </div>
                    
                    <div class="discussion-content">
                        <div class="discussion-header">
                            <div class="discussion-title">
                                <h3>
                                    <a href="/discussion/{id}/" class="title-link">{title}</a>
                                    {pinned_badge}
                                    {featured_badge}
                                </h3>
                                <div class="discussion-meta">
                                    <span class="meta-item author">
                                        <span class="meta-icon">👤</span>
                                        {author}
                                    </span>
                                    <span class="meta-item time">
                                        <span class="meta-icon">🕒</span>
                                        {time_ago}
                                    </span>
                                    <span class="meta-item type">
                                        <span class="meta-icon">🏷️</span>
                                        {type}
                                    </span>
                                    {cable_badge}
                                </div>
                            </div>
                            
                            <div class="discussion-stats">
                                <div class="stat">
                                    <span class="stat-icon">💬</span>
                                    <span class="stat-value">{reply_count}</span>
                                    <span class="stat-label">replies</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-icon">👁️</span>
                                    <span class="stat-value">{view_count}</span>
                                    <span class="stat-label">views</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="discussion-preview">
                            {content_preview}
                        </div>
                        
                        <div class="discussion-actions">
                            <button class="action-btn reply-btn" data-action="reply">
                                <span>💬</span> Reply
                            </button>
                            <button class="action-btn share-btn" data-action="share">
                                <span>↗️</span> Share
                            </button>
                            <button class="action-btn bookmark-btn" data-action="bookmark">
                                <span>🔖</span> Save
                            </button>
                            {% if user.is_staff %}
                            <button class="action-btn moderate-btn" data-action="moderate">
                                <span>⚙️</span> Moderate
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </template>
        </main>
    </div>
</div>

<!-- Discussion Detail Modal -->
<div class="modal" id="discussionDetailModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalDiscussionTitle">Discussion Title</h2>
            <button class="modal-close" id="closeDiscussionModal">&times;</button>
        </div>
        <div class="modal-body" id="modalDiscussionContent">
            <!-- Discussion content loaded via JavaScript -->
        </div>
    </div>
</div>

<!-- Reply Modal -->
<div class="modal" id="replyModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Reply to Discussion</h2>
            <button class="modal-close" id="closeReplyModal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="replyForm">
                {% csrf_token %}
                <input type="hidden" id="replyDiscussionId">
                
                <div class="form-group">
                    <label for="replyContent">Your Reply *</label>
                    <textarea id="replyContent" 
                             class="form-control" 
                             rows="4"
                             placeholder="Write your reply..."
                             maxlength="2000"
                             required></textarea>
                    <div class="form-help">Be constructive and respectful</div>
                    <div class="char-counter">
                        <span id="replyCharCount">0</span>/2000 characters
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-icon">💬</span>
                        Post Reply
                    </button>
                    <button type="button" class="btn btn-outline" id="cancelReply">
                        Cancel
                    </button>
                    <div class="form-note">
                        Earn 2 ZETA tokens for helpful replies
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/discussion.js"></script>
<script>
    // Discussion page initialization
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Initializing discussion page...');
        
        // Initialize discussion system
        if (typeof initDiscussionSystem === 'function') {
            initDiscussionSystem();
        }
        
        // Load initial data
        loadDiscussions();
        loadStatistics();
        loadTopContributors();
        
        // Setup event listeners
        setupDiscussionEvents();
        
        // Update character counters
        setupCharCounters();
    });
    
    function loadDiscussions() {
        const loadingElement = document.getElementById('discussionsLoading');
        const listElement = document.getElementById('discussionsList');
        const emptyElement = document.getElementById('emptyDiscussions');
        
        if (loadingElement) loadingElement.style.display = 'block';
        if (listElement) listElement.innerHTML = '';
        if (emptyElement) emptyElement.style.display = 'none';
        
        // Get filter values
        const filters = getCurrentFilters();
        
        // Load discussions via API
        fetch(`/api/discussions/?${new URLSearchParams(filters)}`)
            .then(response => response.json())
            .then(data => {
                if (loadingElement) loadingElement.style.display = 'none';
                
                if (data.success && data.discussions.length > 0) {
                    renderDiscussions(data.discussions);
                    renderPagination(data.pagination);
                } else {
                    if (emptyElement) emptyElement.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error loading discussions:', error);
                if (loadingElement) loadingElement.style.display = 'none';
                if (emptyElement) emptyElement.style.display = 'block';
                
                showNotification('Failed to load discussions. Please try again.', 'error');
            });
    }
    
    function loadStatistics() {
        fetch('/api/discussions/stats/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('totalDiscussions').textContent = data.total || 0;
                    document.getElementById('todayDiscussions').textContent = data.today || 0;
                    document.getElementById('totalReplies').textContent = data.total_replies || 0;
                    document.getElementById('activeUsers').textContent = data.active_users || 0;
                }
            })
            .catch(error => {
                console.error('Error loading statistics:', error);
            });
    }
    
    function loadTopContributors() {
        const container = document.getElementById('topContributors');
        if (!container) return;
        
        fetch('/api/discussions/top-contributors/')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.contributors.length > 0) {
                    let html = '';
                    data.contributors.forEach((contributor, index) => {
                        html += `
                            <div class="contributor">
                                <div class="contributor-rank">${index + 1}</div>
                                <div class="contributor-info">
                                    <div class="contributor-name">${contributor.username}</div>
                                    <div class="contributor-stats">
                                        ${contributor.discussions} discussions • ${contributor.replies} replies
                                    </div>
                                </div>
                                <div class="contributor-score">
                                    ${contributor.score} pts
                                </div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p class="empty">No contributors yet</p>';
                }
            })
            .catch(error => {
                console.error('Error loading contributors:', error);
                container.innerHTML = '<p class="error">Failed to load</p>';
            });
    }
    
    function getCurrentFilters() {
        return {
            type: document.getElementById('filterType')?.value || '',
            cable: document.getElementById('filterCable')?.value || '',
            sort: document.getElementById('filterSort')?.value || 'newest',
            time: document.getElementById('filterTime')?.value || '',
            search: document.getElementById('searchDiscussions')?.value || '',
            page: 1
        };
    }
    
    function renderDiscussions(discussions) {
        const listElement = document.getElementById('discussionsList');
        const template = document.getElementById('discussionTemplate');
        
        if (!listElement || !template) return;
        
        let html = '';
        
        discussions.forEach(discussion => {
            let discussionHtml = template.innerHTML;
            
            // Replace placeholders with actual data
            discussionHtml = discussionHtml
                .replace(/{id}/g, discussion.id)
                .replace(/{title}/g, escapeHtml(discussion.title || 'Untitled'))
                .replace(/{vote_score}/g, discussion.vote_score || 0)
                .replace(/{author}/g, escapeHtml(discussion.author || 'Anonymous'))
                .replace(/{time_ago}/g, discussion.time_ago || 'Just now')
                .replace(/{type}/g, getTypeLabel(discussion.type))
                .replace(/{reply_count}/g, discussion.reply_count || 0)
                .replace(/{view_count}/g, discussion.view_count || 0)
                .replace(/{content_preview}/g, escapeHtml(discussion.content_preview || ''))
                .replace(/{pinned_badge}/g, discussion.is_pinned ? '<span class="badge badge-pinned">📌 Pinned</span>' : '')
                .replace(/{featured_badge}/g, discussion.is_featured ? '<span class="badge badge-featured">⭐ Featured</span>' : '')
                .replace(/{cable_badge}/g, discussion.cable_name ? `<span class="badge badge-cable">🔌 ${escapeHtml(discussion.cable_name)}</span>` : '');
            
            html += discussionHtml;
        });
        
        listElement.innerHTML = html;
        
        // Add event listeners to new elements
        attachDiscussionEventListeners();
    }
    
    function renderPagination(pagination) {
        const container = document.getElementById('discussionsPagination');
        if (!container || !pagination) return;
        
        const { current_page, total_pages, has_next, has_prev } = pagination;
        
        let html = '';
        
        if (has_prev) {
            html += `<button class="page-btn" data-page="${current_page - 1}">← Previous</button>`;
        }
        
        // Page numbers
        const startPage = Math.max(1, current_page - 2);
        const endPage = Math.min(total_pages, current_page + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            if (i === current_page) {
                html += `<span class="page-current">${i}</span>`;
            } else {
                html += `<button class="page-btn" data-page="${i}">${i}</button>`;
            }
        }
        
        if (has_next) {
            html += `<button class="page-btn" data-page="${current_page + 1}">Next →</button>`;
        }
        
        container.innerHTML = html;
        
        // Add event listeners to page buttons
        container.querySelectorAll('.page-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const page = parseInt(this.dataset.page);
                loadPage(page);
            });
        });
    }
    
    function loadPage(page) {
        // Update URL or load discussions for specific page
        console.log('Loading page:', page);
        // Implementation depends on your pagination strategy
    }
    
    function getTypeLabel(type) {
        const types = {
            'general': 'General',
            'cable': 'Cable',
            'technical': 'Technical',
            'news': 'News',
            'suggestion': 'Suggestion'
        };
        return types[type] || 'General';
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function setupDiscussionEvents() {
        // Filter application
        document.getElementById('applyFilters')?.addEventListener('click', loadDiscussions);
        document.getElementById('resetFilters')?.addEventListener('click', function() {
            document.getElementById('filterType').value = '';
            document.getElementById('filterCable').value = '';
            document.getElementById('filterSort').value = 'newest';
            document.getElementById('filterTime').value = '';
            document.getElementById('searchDiscussions').value = '';
            loadDiscussions();
        });
        
        // Search
        const searchInput = document.getElementById('searchDiscussions');
        const searchBtn = document.getElementById('searchBtn');
        
        let searchTimeout;
        searchInput?.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadDiscussions();
            }, 500);
        });
        
        searchBtn?.addEventListener('click', loadDiscussions);
        
        // Refresh button
        document.getElementById('refreshDiscussions')?.addEventListener('click', loadDiscussions);
        
        // Create discussion form
        const toggleBtn = document.getElementById('toggleCreateForm');
        const createForm = document.getElementById('createDiscussionForm');
        const cancelBtn = document.getElementById('cancelDiscussion');
        const startFirstBtn = document.getElementById('startFirstDiscussion');
        
        toggleBtn?.addEventListener('click', function() {
            const isVisible = createForm.style.display !== 'none';
            createForm.style.display = isVisible ? 'none' : 'block';
            toggleBtn.querySelector('.toggle-icon').textContent = isVisible ? '+' : '−';
        });
        
        cancelBtn?.addEventListener('click', function() {
            createForm.style.display = 'none';
            toggleBtn.querySelector('.toggle-icon').textContent = '+';
        });
        
        startFirstBtn?.addEventListener('click', function() {
            createForm.style.display = 'block';
            toggleBtn.querySelector('.toggle-icon').textContent = '−';
            createForm.scrollIntoView({ behavior: 'smooth' });
        });
        
        // Form submission
        const discussionForm = document.getElementById('newDiscussionForm');
        discussionForm?.addEventListener('submit', function(e) {
            e.preventDefault();
            createDiscussion();
        });
    }
    
    function setupCharCounters() {
        const contentInput = document.getElementById('discussionContent');
        const charCount = document.getElementById('charCount');
        const replyInput = document.getElementById('replyContent');
        const replyCharCount = document.getElementById('replyCharCount');
        
        if (contentInput && charCount) {
            contentInput.addEventListener('input', function() {
                charCount.textContent = this.value.length;
                charCount.style.color = this.value.length > 5000 ? '#e74c3c' : '';
            });
        }
        
        if (replyInput && replyCharCount) {
            replyInput.addEventListener('input', function() {
                replyCharCount.textContent = this.value.length;
                replyCharCount.style.color = this.value.length > 2000 ? '#e74c3c' : '';
            });
        }
    }
    
    function attachDiscussionEventListeners() {
        // Vote buttons
        document.querySelectorAll('.vote-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const discussionId = this.closest('.discussion-item').dataset.discussionId;
                const action = this.dataset.action;
                voteDiscussion(discussionId, action);
            });
        });
        
        // Action buttons
        document.querySelectorAll('.action-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const discussionId = this.closest('.discussion-item').dataset.discussionId;
                const action = this.dataset.action;
                
                switch (action) {
                    case 'reply':
                        openReplyModal(discussionId);
                        break;
                    case 'share':
                        shareDiscussion(discussionId);
                        break;
                    case 'bookmark':
                        bookmarkDiscussion(discussionId);
                        break;
                    case 'moderate':
                        moderateDiscussion(discussionId);
                        break;
                }
            });
        });
        
        // Title links (prevent default if we want modal view)
        document.querySelectorAll('.title-link').forEach(link => {
            link.addEventListener('click', function(e) {
                // Optional: Open in modal instead of new page
                // e.preventDefault();
                // const discussionId = this.closest('.discussion-item').dataset.discussionId;
                // viewDiscussion(discussionId);
            });
        });
    }
    
    // API functions
    function createDiscussion() {
        const form = document.getElementById('newDiscussionForm');
        const submitBtn = document.getElementById('submitDiscussion');
        
        if (!form || !submitBtn) return;
        
        const title = document.getElementById('discussionTitle').value.trim();
        const content = document.getElementById('discussionContent').value.trim();
        const type = document.getElementById('discussionType').value;
        const cable = document.getElementById('discussionCable').value;
        
        if (!title || !content) {
            showNotification('Please fill in all required fields', 'error');
            return;
        }
        
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Creating...';
        submitBtn.disabled = true;
        
        const data = {
            title: title,
            content: content,
            type: type,
            cable_id: cable || null
        };
        
        fetch('/api/discussions/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.csrfToken
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Discussion created successfully!', 'success');
                form.reset();
                document.getElementById('charCount').textContent = '0';
                document.getElementById('createDiscussionForm').style.display = 'none';
                document.getElementById('toggleCreateForm').querySelector('.toggle-icon').textContent = '+';
                
                // Reload discussions
                loadDiscussions();
                loadStatistics();
                loadTopContributors();
                
                // Award points
                updateWalletBalance();
            } else {
                showNotification(data.error || 'Failed to create discussion', 'error');
            }
        })
        .catch(error => {
            console.error('Error creating discussion:', error);
            showNotification('Network error. Please try again.', 'error');
        })
        .finally(() => {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        });
    }
    
    function voteDiscussion(discussionId, action) {
        if (!window.appConfig.userAuthenticated) {
            showNotification('Please login to vote', 'warning');
            window.location.href = `/accounts/login/?next=${window.location.pathname}`;
            return;
        }
        
        fetch(`/api/discussions/${discussionId}/vote/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.csrfToken
            },
            body: JSON.stringify({ action: action })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update vote count display
                const discussionElement = document.querySelector(`.discussion-item[data-discussion-id="${discussionId}"]`);
                if (discussionElement) {
                    const voteCountElement = discussionElement.querySelector('.vote-count');
                    if (voteCountElement) {
                        voteCountElement.textContent = data.new_score;
                    }
                }
                showNotification('Vote recorded!', 'success');
            } else {
                showNotification(data.error || 'Failed to vote', 'error');
            }
        })
        .catch(error => {
            console.error('Error voting:', error);
            showNotification('Network error. Please try again.', 'error');
        });
    }
    
    function openReplyModal(discussionId) {
        if (!window.appConfig.userAuthenticated) {
            showNotification('Please login to reply', 'warning');
            window.location.href = `/accounts/login/?next=${window.location.pathname}`;
            return;
        }
        
        document.getElementById('replyDiscussionId').value = discussionId;
        document.getElementById('replyModal').style.display = 'block';
        
        // Get discussion title for context
        const discussionElement = document.querySelector(`.discussion-item[data-discussion-id="${discussionId}"]`);
        if (discussionElement) {
            const title = discussionElement.querySelector('.title-link')?.textContent;
            if (title) {
                document.getElementById('replyModal').querySelector('h2').textContent = `Reply to: ${title}`;
            }
        }
        
        // Setup form submission
        const replyForm = document.getElementById('replyForm');
        replyForm.onsubmit = function(e) {
            e.preventDefault();
            submitReply(discussionId);
        };
    }
    
    function submitReply(discussionId) {
        const content = document.getElementById('replyContent').value.trim();
        
        if (!content) {
            showNotification('Please enter your reply', 'error');
            return;
        }
        
        fetch(`/api/discussions/${discussionId}/reply/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.csrfToken
            },
            body: JSON.stringify({ content: content })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Reply posted successfully!', 'success');
                document.getElementById('replyModal').style.display = 'none';
                document.getElementById('replyContent').value = '';
                document.getElementById('replyCharCount').textContent = '0';
                
                // Update reply count
                const discussionElement = document.querySelector(`.discussion-item[data-discussion-id="${discussionId}"]`);
                if (discussionElement) {
                    const replyCountElement = discussionElement.querySelector('.stat-value');
                    if (replyCountElement) {
                        const currentCount = parseInt(replyCountElement.textContent) || 0;
                        replyCountElement.textContent = currentCount + 1;
                    }
                }
                
                // Award points
                updateWalletBalance();
            } else {
                showNotification(data.error || 'Failed to post reply', 'error');
            }
        })
        .catch(error => {
            console.error('Error posting reply:', error);
            showNotification('Network error. Please try again.', 'error');
        });
    }
    
    function shareDiscussion(discussionId) {
        const url = `${window.location.origin}/discussion/${discussionId}/`;
        const title = document.querySelector(`.discussion-item[data-discussion-id="${discussionId}"] .title-link`)?.textContent || 'Discussion';
        
        if (navigator.share) {
            navigator.share({
                title: title,
                text: 'Check out this discussion on Z96A Network',
                url: url
            });
        } else {
            // Fallback: Copy to clipboard
            navigator.clipboard.writeText(url).then(() => {
                showNotification('Link copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('Link copied to clipboard!', 'success');
            });
        }
    }
    
    function bookmarkDiscussion(discussionId) {
        if (!window.appConfig.userAuthenticated) {
            showNotification('Please login to save discussions', 'warning');
            return;
        }
        
        fetch(`/api/discussions/${discussionId}/bookmark/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': window.csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.bookmarked ? 'Discussion saved!' : 'Discussion removed from saves', 'success');
            } else {
                showNotification(data.error || 'Failed to save discussion', 'error');
            }
        })
        .catch(error => {
            console.error('Error bookmarking:', error);
            showNotification('Network error. Please try again.', 'error');
        });
    }
    
    function moderateDiscussion(discussionId) {
        // Implementation for moderation actions
        console.log('Moderate discussion:', discussionId);
        // This would open a moderation panel with options like pin, feature, delete, etc.
    }
    
    function updateWalletBalance() {
        // Update wallet balance display after earning tokens
        const walletBalance = document.getElementById('walletBalance');
        if (!walletBalance) return;
        
        fetch('/api/wallet/balance/')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.balance !== undefined) {
                    walletBalance.textContent = `${data.balance} ZETA`;
                }
            })
            .catch(error => console.error('Error updating wallet balance:', error));
    }
    
    // Modal close handlers
    document.getElementById('closeReplyModal')?.addEventListener('click', function() {
        document.getElementById('replyModal').style.display = 'none';
    });
    
    document.getElementById('cancelReply')?.addEventListener('click', function() {
        document.getElementById('replyModal').style.display = 'none';
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        const replyModal = document.getElementById('replyModal');
        if (replyModal && event.target === replyModal) {
            replyModal.style.display = 'none';
        }
        
        const detailModal = document.getElementById('discussionDetailModal');
        if (detailModal && event.target === detailModal) {
            detailModal.style.display = 'none';
        }
    });
    
    // Global functions
    window.loadDiscussions = loadDiscussions;
    window.openReplyModal = openReplyModal;
    window.shareDiscussion = shareDiscussion;
</script>

<style>
    /* Discussion page specific styles */
    .discussion-layout {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 2rem;
        min-height: 80vh;
    }
    
    .discussion-sidebar {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid var(--border-color);
        align-self: start;
        position: sticky;
        top: 1rem;
    }
    
    .sidebar-section {
        margin-bottom: 2rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid var(--border-color);
    }
    
    .sidebar-section:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }
    
    .sidebar-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        font-size: 1.1rem;
    }
    
    .sidebar-icon {
        font-size: 1.2rem;
    }
    
    .filter-group {
        margin-bottom: 1rem;
    }
    
    .filter-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    
    .filter-select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-color);
        color: var(--text-color);
        font-size: 0.9rem;
    }
    
    .filter-select:focus {
        outline: none;
        border-color: var(--primary-color);
    }
    
    .btn-block {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }
    
    .stat {
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 0.75rem;
        text-align: center;
    }
    
    .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 0.25rem;
    }
    
    .stat-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }
    
    .contributors-list {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .contributor {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: var(--bg-secondary);
        border-radius: 8px;
        transition: all 0.2s ease;
    }
    
    .contributor:hover {
        background: var(--bg-hover);
        transform: translateX(3px);
    }
    
    .contributor-rank {
        width: 24px;
        height: 24px;
        background: var(--primary-color);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: 600;
        margin-right: 0.75rem;
    }
    
    .contributor-info {
        flex: 1;
    }
    
    .contributor-name {
        font-weight: 500;
        margin-bottom: 0.25rem;
    }
    
    .contributor-stats {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }
    
    .contributor-score {
        background: var(--success-color);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .guidelines {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .guideline {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
    }
    
    .guideline-icon {
        font-size: 1.2rem;
        width: 24px;
        text-align: center;
    }
    
    .guideline-text {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }
    
    .discussion-main {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }
    
    .create-discussion-card {
        background: var(--card-bg);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        overflow: hidden;
    }
    
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        background: rgba(52, 152, 219, 0.1);
        border-bottom: 1px solid var(--border-color);
    }
    
    .btn-toggle {
        background: var(--primary-color);
        color: white;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-toggle:hover {
        background: var(--primary-dark);
        transform: rotate(90deg);
    }
    
    .toggle-icon {
        font-size: 1.2rem;
        font-weight: bold;
        transition: transform 0.2s ease;
    }
    
    .create-form {
        padding: 1.5rem;
        border-top: 1px solid var(--border-color);
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    
    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-color);
        color: var(--text-color);
        font-family: inherit;
        font-size: 1rem;
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    textarea.form-control {
        min-height: 100px;
        resize: vertical;
    }
    
    .form-help {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }
    
    .char-counter {
        text-align: right;
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }
    
    .form-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-top: 1.5rem;
    }
    
    .form-note {
        flex: 1;
        text-align: right;
        font-size: 0.85rem;
        color: var(--text-secondary);
    }
    
    .btn-icon {
        margin-right: 0.5rem;
    }
    
    .discussions-container {
        background: var(--card-bg);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        overflow: hidden;
    }
    
    .discussions-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
    }
    
    .header-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
    }
    
    .search-box {
        position: relative;
        width: 300px;
    }
    
    .search-input {
        width: 100%;
        padding: 0.5rem 1rem 0.5rem 2.5rem;
        border: 1px solid var(--border-color);
        border-radius: 20px;
        background: var(--bg-color);
        color: var(--text-color);
        font-size: 0.9rem;
    }
    
    .search-input:focus {
        outline: none;
        border-color: var(--primary-color);
    }
    
    .search-btn {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 1rem;
    }
    
    .discussion-section {
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
    }
    
    .discussion-section:last-child {
        border-bottom: none;
    }
    
    .section-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        font-size: 1.2rem;
    }
    
    .section-icon {
        font-size: 1.5rem;
    }
    
    .loading-state {
        text-align: center;
        padding: 3rem;
    }
    
    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--border-color);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .spinner-small {
        width: 20px;
        height: 20px;
        border: 2px solid var(--border-color);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
    }
    
    .empty-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .discussion-item {
        display: flex;
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        transition: all 0.2s ease;
    }
    
    .discussion-item:hover {
        background: var(--bg-hover);
    }
    
    .discussion-item:last-child {
        border-bottom: none;
    }
    
    .discussion-votes {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-right: 1.5rem;
        min-width: 40px;
    }
    
    .vote-btn {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 1.2rem;
        padding: 0.25rem;
        border-radius: 4px;
        transition: all 0.2s ease;
    }
    
    .vote-btn:hover {
        background: var(--bg-secondary);
        color: var(--primary-color);
    }
    
    .vote-btn.upvote:hover {
        color: #2ecc71;
    }
    
    .vote-btn.downvote:hover {
        color: #e74c3c;
    }
    
    .vote-count {
        font-weight: 600;
        margin: 0.25rem 0;
        font-size: 1.2rem;
    }
    
    .discussion-content {
        flex: 1;
    }
    
    .discussion-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.75rem;
    }
    
    .discussion-title h3 {
        margin: 0 0 0.5rem 0;
        font-size: 1.1rem;
    }
    
    .title-link {
        color: var(--text-color);
        text-decoration: none;
    }
    
    .title-link:hover {
        color: var(--primary-color);
    }
    
    .discussion-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        font-size: 0.85rem;
        color: var(--text-secondary);
    }
    
    .meta-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .meta-icon {
        font-size: 0.9rem;
    }
    
    .badge {
        display: inline-block;
        padding: 0.15rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
        vertical-align: middle;
    }
    
    .badge-pinned {
        background: #f39c12;
        color: white;
    }
    
    .badge-featured {
        background: #9b59b6;
        color: white;
    }
    
    .badge-cable {
        background: #3498db;
        color: white;
    }
    
    .discussion-stats {
        display: flex;
        gap: 1rem;
    }
    
    .stat {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.85rem;
        color: var(--text-secondary);
    }
    
    .stat-icon {
        font-size: 1rem;
    }
    
    .stat-value {
        font-weight: 600;
    }
    
    .discussion-preview {
        color: var(--text-secondary);
        line-height: 1.5;
        margin-bottom: 1rem;
        max-height: 4.5em;
        overflow: hidden;
        position: relative;
    }
    
    .discussion-preview:after {
        content: '';
        position: absolute;
        bottom: 0;
        right: 0;
        width: 50%;
        height: 1.5em;
        background: linear-gradient(to right, transparent, var(--card-bg));
    }
    
    .discussion-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .action-btn {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.4rem 0.75rem;
        background: var(--bg-secondary);
        border: none;
        border-radius: 20px;
        color: var(--text-secondary);
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .action-btn:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-1px);
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        padding: 1.5rem;
        border-top: 1px solid var(--border-color);
    }
    
    .page-btn {
        padding: 0.5rem 0.75rem;
        background: var(--bg-secondary);
        border: none;
        border-radius: 6px;
        color: var(--text-color);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .page-btn:hover {
        background: var(--primary-color);
        color: white;
    }
    
    .page-current {
        padding: 0.5rem 0.75rem;
        background: var(--primary-color);
        color: white;
        border-radius: 6px;
        font-weight: 600;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
    }
    
    .modal-content {
        background: var(--card-bg);
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-secondary);
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }
    
    .modal-close:hover {
        background: var(--bg-hover);
        color: var(--text-color);
    }
    
    .modal-body {
        padding: 1.5rem;
    }
    
    @media (max-width: 1024px) {
        .discussion-layout {
            grid-template-columns: 1fr;
        }
        
        .discussion-sidebar {
            position: static;
        }
    }
    
    @media (max-width: 768px) {
        .discussions-header {
            flex-direction: column;
            align-items: stretch;
            gap: 1rem;
        }
        
        .header-actions {
            flex-direction: column;
        }
        
        .search-box {
            width: 100%;
        }
        
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .form-actions {
            flex-direction: column;
            align-items: stretch;
        }
        
        .form-note {
            text-align: center;
        }
        
        .discussion-header {
            flex-direction: column;
            gap: 1rem;
        }
        
        .discussion-stats {
            justify-content: flex-start;
        }
    }
</style>
{% endblock %}